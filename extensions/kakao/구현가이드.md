# 카카오톡 채널 연동 구현 가이드

## 개요

이 문서는 OpenClaw와 카카오톡 메시징 플랫폼 간의 연동을 위한 구현 가이드입니다.

## 프로젝트 구조

```
extensions/kakao/
├── README.md                 # 프로젝트 소개 및 사용법
├── DESIGN.md                 # 상세 설계 문서 (영문)
├── CHANGELOG.md              # 변경 이력
├── 구현가이드.md             # 한글 구현 가이드 (본 문서)
├── package.json              # NPM 패키지 설정
├── openclaw.plugin.json      # 플러그인 메타데이터
├── index.ts                  # 플러그인 진입점
└── src/                      # 소스 코드 디렉토리 (예정)
    ├── provider.ts           # 채널 프로바이더
    ├── oauth.ts              # OAuth 2.0 인증
    ├── messages.ts           # 메시지 처리
    ├── templates.ts          # 템플릿 관리
    ├── api-client.ts         # Kakao API 클라이언트
    └── media.ts              # 미디어 처리
```

## 카카오톡 API 개요

### 1. 지원되는 API 타입

#### 카카오톡 메시지 API
- **나에게 보내기**: 자기 자신에게 메시지 전송
- **친구에게 보내기**: 카카오톡 친구에게 메시지 전송
- 같은 서비스 내 사용자 간 메시지 발송 지원
- 카카오톡 소셜 API 사용 권한 필요

#### 카카오톡 채널 API
- 비즈니스 홈(카카오톡 채널) 활용
- 채널 추가 페이지 연결
- 1:1 채팅 시작 기능
- 채널 관리 및 프로필 업데이트

#### 비즈 메시지 API
- **알림톡 (AlimTalk)**: 정보성 메시지 발송
  - 주문 확인, 배송 알림, 예약 확인 등
  - 사전 승인된 템플릿 필요
  - SMS보다 저렴하고 높은 도달률
- **친구톡 (FriendTalk)**: 마케팅 메시지 발송
  - 채널 친구에게만 발송 가능
  - 자유로운 형식의 콘텐츠
  - 이미지, 버튼 등 다양한 형식 지원

### 2. 사전 준비 사항

#### 카카오톡 채널 생성
1. [카카오톡 채널 관리자센터](https://center-pf.kakao.com) 접속
2. "채널 만들기" 클릭
3. 채널 정보 입력 (이름, 프로필 이미지, 설명)
4. 채널 ID 확인 (형식: `_abc123`)

#### 카카오 개발자 앱 등록
1. [Kakao Developers 콘솔](https://developers.kakao.com/console) 접속
2. "애플리케이션 추가하기" 클릭
3. 앱 키 확인:
   - JavaScript 키 (앱 키)
   - REST API 키
4. 플랫폼 설정에서 도메인 추가
5. "카카오톡 채널" 설정에서 채널 연결

#### API 활성화
다음 API를 개발자 콘솔에서 활성화:
- 카카오톡 메시지 API
- 카카오톡 채널 API
- (선택) 카카오톡 소셜 API (친구 목록 조회용)

#### OAuth 2.0 설정
1. Redirect URI 설정 (예: `https://your-gateway.com/oauth/kakao`)
2. 동의 항목 설정:
   - "카카오톡으로 메시지 보내기"
   - "카카오톡 채널 관계 확인하기"
   - "카카오톡 채널 관계 추가 및 해제"

## 구현 단계

### Phase 1: 핵심 기능 구현 (MVP)

**목표**: 기본적인 메시지 송수신 기능 구현

**구현 항목**:
1. **API 클라이언트 (`src/api-client.ts`)**
   ```typescript
   class KakaoApiClient {
     constructor(config: KakaoConfig);
     async sendMessage(params: MessageParams): Promise<SendResult>;
     async getUserInfo(accessToken: string): Promise<UserInfo>;
   }
   ```

2. **OAuth 인증 (`src/oauth.ts`)**
   ```typescript
   class OAuthHandler {
     async getAuthorizationUrl(): Promise<string>;
     async exchangeToken(code: string): Promise<TokenResponse>;
     async refreshToken(refreshToken: string): Promise<TokenResponse>;
   }
   ```

3. **메시지 핸들러 (`src/messages.ts`)**
   ```typescript
   class MessageHandler {
     async handleIncoming(event: WebhookEvent): Promise<void>;
     async sendOutgoing(message: OutgoingMessage): Promise<void>;
   }
   ```

4. **채널 프로바이더 (`src/provider.ts`)**
   ```typescript
   class KakaoChannelProvider implements ChannelProvider {
     async initialize(): Promise<void>;
     async sendMessage(envelope: MessageEnvelope): Promise<void>;
     async handleWebhook(event: WebhookEvent): Promise<void>;
   }
   ```

### Phase 2: 고급 메시징 기능

**구현 항목**:
1. 알림톡 템플릿 지원
2. 친구톡 메시지 발송
3. 이미지 업로드/다운로드
4. 버튼 및 액션 지원
5. 기본 메시지 템플릿 (텍스트, 피드, 리스트 등)

### Phase 3: 채널 관리 기능

**구현 항목**:
1. 친구 목록 관리
2. 채널 프로필 업데이트
3. 커스텀 템플릿 관리
4. 분석 및 추적
5. 대량 메시지 발송

### Phase 4: 엔터프라이즈 기능

**구현 항목**:
1. 멀티 어카운트 지원
2. 고급 속도 제한
3. 메시지 스케줄링
4. A/B 테스트 지원
5. 상세 로깅 및 모니터링

## API 통합 가이드

### REST API 기본 사용법

#### 1. 나에게 메시지 보내기

**엔드포인트**: `POST https://kapi.kakao.com/v2/api/talk/memo/default/send`

**헤더**:
```
Authorization: Bearer {access_token}
Content-Type: application/json; charset=utf-8
```

**요청 본문**:
```json
{
  "template_object": {
    "object_type": "text",
    "text": "OpenClaw에서 보낸 메시지입니다!",
    "link": {
      "web_url": "https://openclaw.ai",
      "mobile_web_url": "https://openclaw.ai"
    }
  }
}
```

#### 2. 친구에게 메시지 보내기

**엔드포인트**: `POST https://kapi.kakao.com/v1/api/talk/friends/message/default/send`

**요청 본문**:
```json
{
  "receiver_uuids": ["uuid1", "uuid2"],
  "template_object": {
    "object_type": "feed",
    "content": {
      "title": "새로운 메시지",
      "description": "새로운 메시지가 도착했습니다",
      "image_url": "https://example.com/image.jpg",
      "link": {
        "web_url": "https://example.com"
      }
    }
  }
}
```

#### 3. 사용자 정보 조회

**엔드포인트**: `GET https://kapi.kakao.com/v2/user/me`

**응답**:
```json
{
  "id": 123456789,
  "kakao_account": {
    "profile": {
      "nickname": "홍길동",
      "profile_image_url": "https://example.com/profile.jpg"
    }
  }
}
```

### 알림톡 (AlimTalk) 구현

#### 템플릿 등록 과정

1. **비즈니스 채널 설정**
   - 카카오톡 채널을 비즈니스 채널로 전환
   - 발신 프로필 등록 및 인증

2. **템플릿 작성**
   - [메시지 템플릿 도구](https://business.kakao.com/dashboard) 접속
   - 템플릿 코드, 내용, 버튼 등 작성
   - 변수 위치 지정 (예: `#{주문번호}`)

3. **템플릿 검수**
   - 템플릿 제출
   - 카카오 검수팀 검토 (1-2 영업일)
   - 승인 후 템플릿 코드 발급

4. **템플릿 사용**
   ```typescript
   const result = await sendAlimTalk({
     senderKey: "your-sender-key",
     phoneNumber: "01012345678",
     templateCode: "template_001",
     templateParameter: {
       주문번호: "ORD-2026-001",
       배송일: "2026-02-10",
       추적URL: "https://tracking.example.com"
     }
   });
   ```

#### 템플릿 예시

**주문 확인 템플릿**:
```
[주문 완료]
주문번호: #{주문번호}
주문일시: #{주문일시}
총 금액: #{총금액}원

자세한 내용은 아래 버튼을 눌러 확인하세요.
```

**배송 알림 템플릿**:
```
[배송 시작]
주문번호: #{주문번호}
송장번호: #{송장번호}
배송 예정일: #{배송예정일}

배송 현황을 실시간으로 확인하세요.
```

### OAuth 2.0 인증 플로우

#### 1. 인증 URL 생성
```typescript
const authUrl = `https://kauth.kakao.com/oauth/authorize?` +
  `client_id=${APP_KEY}&` +
  `redirect_uri=${REDIRECT_URI}&` +
  `response_type=code&` +
  `scope=talk_message,friends`;
```

#### 2. 사용자 로그인 및 동의
- 사용자가 카카오 로그인 페이지로 이동
- 로그인 후 권한 동의
- Redirect URI로 authorization code 전달

#### 3. 토큰 교환
```typescript
const tokenResponse = await fetch('https://kauth.kakao.com/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'authorization_code',
    client_id: APP_KEY,
    redirect_uri: REDIRECT_URI,
    code: authorizationCode,
  }),
});

const tokens = await tokenResponse.json();
// {
//   access_token: "...",
//   refresh_token: "...",
//   expires_in: 21599,
//   refresh_token_expires_in: 5183999
// }
```

#### 4. 토큰 갱신
```typescript
const refreshResponse = await fetch('https://kauth.kakao.com/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'refresh_token',
    client_id: APP_KEY,
    refresh_token: refreshToken,
  }),
});
```

## 설정 예시

### 기본 설정 (`~/.openclaw/config.json`)

```json5
{
  channels: {
    kakao: {
      enabled: true,

      // 인증 정보
      appKey: "your-javascript-key",
      restApiKey: "your-rest-api-key",
      channelId: "_abc123",

      // 접근 제어
      dmPolicy: "pairing",
      allowFrom: ["user123", "user456"],

      // 메시지 타입 설정
      messageTypes: {
        alimtalk: {
          enabled: true,
          senderKey: "your-sender-key",
          templates: {
            orderConfirm: {
              templateId: "template_001",
              templateCode: "ORDER_CONFIRM",
              variables: ["주문번호", "주문일시", "총금액"]
            },
            shipmentNotice: {
              templateId: "template_002",
              templateCode: "SHIP_NOTICE",
              variables: ["주문번호", "송장번호", "배송예정일"]
            }
          }
        },
        friendtalk: {
          enabled: true
        }
      },

      // OAuth 설정
      oauth: {
        redirectUri: "https://your-gateway.com/oauth/kakao",
        scopes: ["talk_message", "friends"]
      },

      // API 설정
      mediaMaxMb: 2,
      retry: {
        maxAttempts: 3,
        initialDelayMs: 1000,
        maxDelayMs: 30000
      }
    }
  }
}
```

### 멀티 어카운트 설정

```json5
{
  channels: {
    kakao: {
      enabled: true,
      accounts: {
        main: {
          name: "메인 채널",
          appKey: "main-app-key",
          restApiKey: "main-rest-api-key",
          channelId: "_main123",
          dmPolicy: "pairing"
        },
        support: {
          name: "고객지원 채널",
          appKey: "support-app-key",
          restApiKey: "support-rest-api-key",
          channelId: "_support456",
          dmPolicy: "allowlist",
          allowFrom: ["support-user-1", "support-user-2"]
        }
      }
    }
  }
}
```

## 에러 처리

### 일반적인 에러 코드

| 코드 | 설명 | 처리 방법 |
|------|------|-----------|
| 401 | 인증 실패 | 토큰 갱신 후 재시도 |
| 403 | 권한 부족 | 스코프 확인, 재인증 필요 |
| 429 | 속도 제한 초과 | 지수 백오프로 재시도 |
| 500 | 서버 오류 | 재시도 로직 실행 |
| -401 | 잘못된 앱 키 | 설정 확인 |
| -402 | 유효하지 않은 토큰 | 토큰 갱신 |

### 재시도 전략

```typescript
interface RetryConfig {
  maxAttempts: 3,        // 최대 재시도 횟수
  initialDelayMs: 1000,  // 초기 지연 시간
  maxDelayMs: 30000,     // 최대 지연 시간
  backoffMultiplier: 2,  // 백오프 배수
  retryableErrors: [429, 500, 502, 503]
}
```

## 테스트 가이드

### 단위 테스트

```bash
# 전체 테스트 실행
pnpm test extensions/kakao

# 특정 파일 테스트
pnpm test extensions/kakao/src/api-client.test.ts

# 커버리지 확인
pnpm test:coverage extensions/kakao
```

### 통합 테스트

실제 카카오 API를 사용하는 통합 테스트:

```bash
# 환경 변수 설정
export KAKAO_APP_KEY="your-test-app-key"
export KAKAO_REST_API_KEY="your-test-rest-api-key"
export KAKAO_TEST_USER_ID="test-user-id"

# 라이브 테스트 실행
LIVE=1 pnpm test extensions/kakao
```

### 수동 테스트 체크리스트

- [ ] 카카오 채널 생성 및 설정
- [ ] 개발자 앱 등록 및 API 활성화
- [ ] OAuth 인증 플로우 테스트
- [ ] 나에게 메시지 보내기
- [ ] 친구에게 메시지 보내기
- [ ] 알림톡 템플릿 등록 및 발송
- [ ] 이미지 업로드 및 전송
- [ ] 버튼 클릭 동작 확인
- [ ] 웹훅 이벤트 수신 확인
- [ ] 에러 처리 시나리오

## 배포 가이드

### NPM 패키지 배포

```bash
# 버전 업데이트
npm version patch  # or minor, major

# 패키지 빌드
pnpm build

# NPM 배포
npm publish --access public
```

### 로컬 설치 테스트

```bash
# 소스에서 설치
openclaw plugins install ./extensions/kakao

# 게이트웨이 재시작
openclaw gateway restart

# 상태 확인
openclaw channels status
```

## 성능 최적화

### 캐싱 전략

1. **친구 목록**: 30분 TTL
2. **승인된 템플릿**: 24시간 TTL
3. **사용자 프로필**: 1시간 TTL
4. **OAuth 토큰**: 만료 시간까지

### 속도 제한

- 앱당 100 req/sec
- 발신 키당 1000 msg/hour (알림톡)
- 토큰 버킷 알고리즘 사용
- 429 에러 시 지수 백오프

## 보안 고려사항

1. **토큰 보안**
   - 토큰은 암호화하여 저장
   - HTTPS만 사용
   - 정기적인 토큰 갱신

2. **웹훅 검증**
   - 서명 검증
   - 타임스탬프 확인 (리플레이 공격 방지)
   - IP 화이트리스트

3. **데이터 프라이버시**
   - 최소한의 데이터 수집
   - 사용자 동의 필수
   - GDPR/개인정보보호법 준수

## 참고 자료

### 공식 문서
- [Kakao Developers](https://developers.kakao.com)
- [REST API 레퍼런스](https://developers.kakao.com/docs/latest/ko/kakaotalk-message/rest-api)
- [메시지 템플릿](https://developers.kakao.com/docs/latest/ko/message/common)
- [OAuth 2.0 가이드](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api)

### 서드파티 리소스
- [Sinch Conversation API](https://developers.sinch.com/docs/conversation/channel-support/kakaotalk)
- [Sendbird Business Messaging](https://sendbird.com/products/business-messaging/kakaotalk)
- [Infobip KakaoTalk API](https://www.infobip.com/docs/kakaotalk/kakaotalk-over-api)

### OpenClaw 문서
- [채널 아키텍처](/concepts/channels)
- [플러그인 개발](/plugin)
- [OAuth 연동](/concepts/oauth)
- [메시지 라우팅](/concepts/routing)

## 다음 단계

1. ✅ 프로젝트 구조 생성 완료
2. ✅ 문서화 완료
3. ⏳ Phase 1 구현 시작
   - API 클라이언트 구현
   - OAuth 핸들러 구현
   - 기본 메시지 송수신
4. ⏳ 테스트 작성
5. ⏳ 베타 버전 배포

## 문의 및 지원

- GitHub Issues: https://github.com/openclaw/openclaw/issues
- Discord: OpenClaw 커뮤니티
- 이메일: support@openclaw.ai
